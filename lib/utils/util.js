"use strict";var fs=require("fs"),path=require("path"),babel=require("babel-core"),stage1=require("babel-preset-stage-1"),es2015=require("babel-preset-es2015"),DOMParser=require("xmldom").DOMParser,uglifyjs=require("uglify-js"),less=require("less"),minCss=require("cssmin"),colors=require("colors"),sh=require("shelljs"),projectPath=process.cwd(),srcPath=path.resolve(projectPath,"src"),distPath=path.resolve(projectPath,"dist"),wexpConfig={};function find_r(e,t){for(var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"{",n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"}",i=[],s=t,c=e.length;s<c;s++){var a=e.charAt(s);if(r==a)i.push(s);else{if(n!=a)continue;if(i.pop(),!i.length)return s+1}}return t}function findstr(e,t){var r=e.indexOf(t),n=0;return-1===r?"":(n=find_r(e,r),e.substring(r,n))}module.exports={getDomParser:function(e){return new DOMParser({locator:{},errorHandler:{warning:function(e){},error:function(e){}}}).parseFromString(e)},getScriptContent:function(e,n){var i="",s=this,t=this.getDomParser(e);return[].slice.call(t.childNodes||[]).forEach(function(e){var t=e.nodeName;if("script"===t&&e.hasAttribute("src")){var r=path.resolve(path.dirname(n),e.getAttribute("src"));i=fs.readFileSync(r,{encoding:"utf8"})}else"script"===t&&[].slice.call(e.childNodes||[]).forEach(function(e){i+=s.parseSpecialCode(e.toString())})}),i},getWxml:function(e){var t="",r=this,n=this.getDomParser(e);return[].slice.call(n.childNodes||[]).forEach(function(e){"template"===e.nodeName&&[].slice.call(e.childNodes||[]).forEach(function(e){t+=r.parseSpecialCode(e.toString())})}),t},getStyle:function(e,v){var y=this,x="",t=process.env.NODE_ENV,r=(this.getRelativePath(v),this.getDomParser(e));return[].slice.call(r.childNodes||[]).forEach(function(e){if("style"===e.nodeName){var t=e.hasAttribute("src"),r=e.hasAttribute("lang"),n=e.getAttribute("src");if(t)if(r){var i=n.split("/"),s=y.getFilename(n),c=y.getFilename(v),a=e.getAttribute("lang");if((2===i.length&&"."===i[0]||1===i.length)&&s===c){var o=y.readFile(v.replace(".xu","."+a));x+=y.renderStyle(a,o)}else{var l='@import "'+e.getAttribute("src").replace("."+a,".wxss")+'";';x+=l}}else if(0<n.indexOf(".wxss")){var u=n.split("/"),f=y.getFilename(n),p=y.getFilename(v),h="wxss";if((2===u.length&&"."===u[0]||1===u.length)&&f===p){var g=y.readFile(v.replace(".xu","."+h));x+=y.renderStyle(h,g)}else{var d='@import "'+e.getAttribute("src")+'";';x+=d}}else y.log(" [style引用错误]".red+" 请搭配lang属性使用");else if(!t&&r){[].slice.call(e.childNodes||[]).forEach(function(e){x+=e.toString()});var m=e.getAttribute("lang");x=y.renderStyle(m,x)}else t||r||[].slice.call(e.childNodes||[]).forEach(function(e){x+=e.toString()})}}),"production"===t&&(x=minCss(x)),x},renderStyle:function(e,r){switch(e){case"less":var n=r.match(/\@import(.*)["']\;/gi);r=r.replace(/\@import(.*)['"]\;/gi,"");try{less.render(r,function(e,t){if(e)throw e;r=t.css.toString(),n&&n.forEach(function(e){r=e.replace(".less",".wxss")+"\n"+r})})}catch(e){this.log(" "+this.catch(e.name).red),console.log(e)}}return r},readFile:function(e){try{return fs.readFileSync(e,{encoding:"utf8"})}catch(e){this.log(" "+this.catch(e.name).red),console.log(e)}},getJsContent:function(e){var t="",r=process.env.NODE_ENV,n=fs.readFileSync(e,{encoding:"utf8"}),i=this.babelJs(n,e);return i&&i.code&&(t=i.code,"production"===r&&(t=this.upjs(i.code).code)),t},compileStyle:function(e,t){var r="",n=process.env.NODE_ENV,i=this.readFile(e);this.getRelativePath(e);return r+=this.renderStyle(t,i),"production"===n&&0<r.length&&(r=minCss(r)),r},hasXuFile:function(e){return fs.existsSync(e)},getFilename:function(e){return e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."))},babelJs:function(e,t){var r=this.getFilename(t),n=this.getRelativePath(t);if(e)try{return babel.transform(e,{filename:r,presets:[es2015,stage1]})}catch(e){this.log(" "+this.catch(e.name).red+" src"+n),console.log(e.stack)}},catch:function(e){var t="[语法错误]";switch(e){case"SyntaxError":t="[语法错误]";break;case"ReferenceError":t="[变量未定义错误]";break;case"RangeError":t="[超出有效值错误]";break;case"TypeError":t="[类型不匹配错误]";break;case"URIError":t="[函数参数不正确错误]";break;case"EvalError":t="[eval函数未执行错误]"}return t},getTypeUrl:function(e){var t=e.replace(path.resolve(process.cwd(),"src"),""),r={type:"app",path:"/"};return 0===t.indexOf("/pages")?r.type="page":0===t.indexOf("/components")?r.type="component":0===t.indexOf("/app.xu")&&(r.type="app"),r},getRelativePath:function(e){return e.replace(srcPath,"")},getConfig:function(e){process.env.NODE_ENV;var t=".config = ";return findstr(e,t).replace(t,"").replace(/(?:\s*['"]*)?([a-zA-Z0-9\-]+)(?:['"]*\s*)?:/g,'"$1":').replace(/'/gi,'"')},getModuleName:function(r,i){if("undefined"!==r)return new Promise(function(e,t){var n=r.match(/require(.*)wexp\/index['"]\)/gi)[0];e(r=r.replace(/exports\.default\s*=\s*(\w+);/gi,function(e,t){if("undefined"===t)return"";var r="";return"page"===i?r="\nPage("+n+".default.$createPage("+t+"));\n":"app"===i?r="\nApp("+n+".default.$createApp("+t+"));\n":"component"===i&&(r="\nComponent("+n+".default.$createComponent("+t+"));\n"),r}))})},writeFile:function(e,t){var r=path.resolve(process.cwd(),"dist"+e),n=r.split("/"),i="/"+n[n.length-1],s=r.replace(i,"");fs.existsSync(s)?fs.writeFileSync(r,t):this.mkdirsSync(s).then(function(e){fs.writeFileSync(r,t)})},mkdirsSync:function(r){var n=this;return new Promise(function(e,t){fs.existsSync(r)?e(!0):n.mkdirsSync(path.dirname(r))&&(fs.mkdirSync(r),e(!0))})},createDir:function(r){return new Promise(function(e,t){r=path.resolve(process.cwd(),"dist"+r),fs.existsSync(distPath)||fs.mkdirSync(r),e()})},upjs:function(e){return uglifyjs.minify(e)},trim:function(e){return e.replace(/\s+/g,"").replace(/[\r\n]/g,"")},log:function(e){var t=this.getTime();console.log(t.grey+e)},getTime:function(){var e=new Date;return"["+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+"]"},delDir:function(e,t){var r=this,n=this.getRelativePath(e),i=path.resolve(process.cwd(),"dist"+n);if(t){var s="rm -rf "+i;sh.exec(s,function(){r.log(" [删除文件夹]".red+" dist"+n)})}else{var c=i.split("/"),a=c[c.length-1],o="rm "+i.replace(a,"")+(a.split(".")[0]+".*");sh.exec(o,function(){n.indexOf(".xu")?["json","js","wxml","wxss"].forEach(function(e){r.log(" [删除文件]".red+" dist"+n.replace(".xu","."+e))}):r.log(" [删除文件]".red+" dist"+n)})}},doCopy:function(){var r=this,n=path.join(__dirname,"../../wexp/dist"),i=path.join(projectPath,"./dist/wexp");fs.exists(i,function(e){if(!e){var t="cp -r "+n+" "+i;sh.exec(t,function(){r.log("拷贝依赖文件".green)})}})},isEmptyObj:function(e){return 0===Object.keys(e).length},getWexpConfig:function(){var e=Object.assign({},wexpConfig);if(this.isEmptyObj(e)){var t=path.resolve(process.cwd(),"wexp.config.js");e=require(t)}return e},parseSpecialCode:function(e){return e.replace(/\&lt\;/gi,"<").replace(/\&amp\;/gi,"&")}};