"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e},_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path=require("path"),_path2=_interopRequireDefault(_path),_babel=require("./babel"),_babel2=_interopRequireDefault(_babel),_babelPresetStage=require("babel-preset-stage-1"),_babelPresetStage2=_interopRequireDefault(_babelPresetStage),_babelPresetEs=require("babel-preset-es2015"),_babelPresetEs2=_interopRequireDefault(_babelPresetEs),_xmldom=require("xmldom"),_uglifyJs=require("uglify-js"),_uglifyJs2=_interopRequireDefault(_uglifyJs),_less=require("less"),_less2=_interopRequireDefault(_less),_cssmin=require("cssmin"),_cssmin2=_interopRequireDefault(_cssmin),_colors=require("colors"),_colors2=_interopRequireDefault(_colors),_sh=require("./sh"),_sh2=_interopRequireDefault(_sh),_readline=require("readline"),_readline2=_interopRequireDefault(_readline),_glob=require("glob"),_glob2=_interopRequireDefault(_glob);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var projectPath=process.cwd(),srcPath=_path2.default.resolve(projectPath,"src"),distPath=_path2.default.resolve(projectPath,"dist"),nodePath=_path2.default.resolve(projectPath,"./node_modules"),configPath=_path2.default.resolve(projectPath,"wexp.config.js"),wexpConfig={},eslintignore=[],comArr=[],config={},configStatus=!1;function find_r(e,t){for(var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"{",i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"}",a=[],n=t,s=e.length;n<s;n++){var l=e.charAt(n);if(r==l)a.push(n);else{if(i!=l)continue;if(a.pop(),!a.length)return n+1}}return t}function findstr(e,t){var r=e.indexOf(t),i=0;return-1===r?"":(i=find_r(e,r),e.substring(r,i))}exports.default={getDomParser:function(e){return new _xmldom.DOMParser({locator:{},errorHandler:{warning:function(e){},error:function(e){}}}).parseFromString(e)},getScriptContent:function(e,i){var a="",n=this,t=this.getDomParser(e);return[].slice.call(t.childNodes||[]).forEach(function(e){var t=e.nodeName;if("script"===t&&e.hasAttribute("src")){var r=_path2.default.resolve(_path2.default.dirname(i),e.getAttribute("src"));a=_fs2.default.readFileSync(r,{encoding:"utf8"})}else"script"===t&&[].slice.call(e.childNodes||[]).forEach(function(e){a+=n.parseSpecialCode(e.toString())})}),a},getWxml:function(e){var t="",r=this,i=this.getDomParser(e);return[].slice.call(i.childNodes||[]).forEach(function(e){"template"===e.nodeName&&[].slice.call(e.childNodes||[]).forEach(function(e){t+=r.parseSpecialCode(e.toString())})}),t},getStyle:function(e,y){var x=this,S="",t=process.env.NODE_ENV,r=(this.getRelativePath(y),this.getDomParser(e));return[].slice.call(r.childNodes||[]).forEach(function(e){if("style"===e.nodeName){var t=e.hasAttribute("src"),r=e.hasAttribute("lang"),i=e.getAttribute("src");if(t)if(r){var a=i.split("/"),n=x.getFilename(i),s=x.getFilename(y),l=e.getAttribute("lang");if((2===a.length&&"."===a[0]||1===a.length)&&n===s){var o=y.replace(".xu","."+l);if(x.hasXuFile(o,!0)){var u=x.readFile(y.replace(".xu","."+l));S+=x.renderStyle(l,u)}else S+=""}else{var c='@import "'+e.getAttribute("src").replace("."+l,".wxss")+'";';S+=c}}else if(0<i.indexOf(".wxss")){var f=i.split("/"),d=x.getFilename(i),p=x.getFilename(y),h="wxss";if((2===f.length&&"."===f[0]||1===f.length)&&d===p){var g=y.replace(".xu","."+h);if(x.hasXuFile(g,!0)){var _=x.readFile(y.replace(".xu","."+h));S+=x.renderStyle(h,_)}else S+=""}else{var v='@import "'+e.getAttribute("src")+'";';S+=v}}else x.log("[错误]".red+" style: 请搭配lang属性使用");else if(!t&&r){[].slice.call(e.childNodes||[]).forEach(function(e){S+=e.toString()});var m=e.getAttribute("lang");S=x.renderStyle(m,S)}else t||r||[].slice.call(e.childNodes||[]).forEach(function(e){S+=e.toString()})}}),"production"===t&&(S=(0,_cssmin2.default)(S)),S},renderStyle:function(e,r){switch(e){case"less":var i=r.match(/\@import(.*)["']\;/gi);r=r.replace(/\@import(.*)['"]\;/gi,"");try{_less2.default.render(r,function(e,t){if(e)throw e;r=t.css.toString(),i&&i.forEach(function(e){r=e.replace(".less",".wxss")+"\n"+r})})}catch(e){this.log(this.catch(e.name).red),console.log(e)}}return r},readFile:function(e){try{return _fs2.default.readFileSync(e,{encoding:"utf8"})}catch(e){this.log(this.catch(e.name).red),console.log(e)}},readFileOnLine:function(i){var a=this;return new Promise(function(t,e){if(a.hasXuFile(i,!0)&&0===eslintignore.length){var r=_readline2.default.createInterface({input:_fs2.default.createReadStream(i)});r.on("line",function(e){eslintignore.push(e)}),r.on("close",function(e){t(eslintignore)})}else t(eslintignore)})},getJsContent:function(e){var t="",r=process.env.NODE_ENV,i=_fs2.default.readFileSync(e,{encoding:"utf8"}),a=this.babelJs(i,e);return a&&a.code&&(t=a.code,"production"===r&&(t=this.upjs(a.code).code)),t},getWxmlContent:function(e){process.env.NODE_ENV;return _fs2.default.readFileSync(e,{encoding:"utf8"})},compileStyle:function(e,t){var r="",i=process.env.NODE_ENV,a=this.readFile(e);this.getRelativePath(e);return r+=this.renderStyle(t,a),"production"===i&&0<r.length&&(r=(0,_cssmin2.default)(r)),r},hasXuFile:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],r=_fs2.default.existsSync(e);if(!r&&t){var i=this.getRelativePath(e);this.log("[找不到文件]".red+" src"+i)}return r},getFilename:function(e){return _path2.default.parse(e).name},babelJs:function(e,t,r){var i=this.getFilename(t),a=this.getWexpConfig().babel||{},n=_extends({filename:i,presets:[_babelPresetEs2.default,_babelPresetStage2.default]},a);if(e)try{return _babel2.default.transform(e,n)}catch(e){if(r){var s=this.getRelativePath(t);this.log(this.catch(e.name).red+" src"+s)}console.log(e.stack)}},catch:function(e){var t="[语法错误]";switch(e){case"SyntaxError":t="[语法错误]";break;case"ReferenceError":t="[变量未定义错误]";break;case"RangeError":t="[超出有效值错误]";break;case"TypeError":t="[类型不匹配错误]";break;case"URIError":t="[函数参数不正确错误]";break;case"EvalError":t="[eval函数未执行错误]"}return t},getTypeUrl:function(e){var t=e.replace(_path2.default.resolve(process.cwd(),"src"),""),r={type:"app",path:"/"};return 0===t.indexOf(_path2.default.sep+"pages")?r.type="page":0===t.indexOf(_path2.default.sep+"components")?r.type="component":0===t.indexOf(_path2.default.sep+"app.xu")&&(r.type="app"),r},getRelativePath:function(e){return e.replace(srcPath,"")},getConfig:function(e){var t=".config = ";return findstr(e,t).replace(t,"").replace(/(?:\s*['"]*)?([a-zA-Z0-9\-]+)(?:['"]*\s*)?:/g,'"$1":').replace(/'/gi,'"').replace(/\.\"/gi,".")},isRelativePath:function(e){return 0===e.indexOf(".")||0===e.indexOf("/")||0===e.indexOf("http")},getNpmComponent:function(r){var f=this;return new Promise(function(e,t){var u=new Function("return "+r)().usingComponents,c=r;u?(Object.keys(u).forEach(function(e){if(!f.isRelativePath(u[e])){var t=u[e].split("/")[0];c=c.replace(u[e],"/npm/"+u[e]);var r=_path2.default.resolve(projectPath,"./node_modules/"+t),i=_path2.default.resolve(r,"package.json");if(_fs2.default.existsSync(i)){var a=_fs2.default.readFileSync(i,{encoding:"utf8"}),n=new Function("return "+a)();if(n.miniprogram){var s=_path2.default.resolve(r,"./"+n.miniprogram);_glob2.default.sync(s+"/**/*.*").forEach(function(e){if(comArr.indexOf(e)<0){comArr.push(e);var t=e.split("node_modules"),r=_fs2.default.readFileSync(e,{encoding:"utf8"}),i=e.replace(t[0]+"node_modules","/npm").replace("/"+n.miniprogram,"");f.writeFile(i,r);var a=f.getExt(e);f.log("[拷贝]".yellow+" "+a+": "+i.substr(1,i.length-1))}})}else{var l=n.main;if(0<=l.indexOf(".xu")){var o=_path2.default.resolve(r,l);comArr.indexOf(o)<0&&(comArr.push(o),f.compileNpmXu(o))}else f.log("未发现xu入口文件".red)}}else f.log("未发现模块".red+t.red)}}),e(c)):e(r)})},compileNpmXu:function(w){var F=this,e=_fs2.default.readFileSync(w,{encoding:"utf8"}),l="/npm"+w.split("node_modules")[1],P=w.replace(".xu",".js"),j=P.replace("node_modules","dist/npm");if(e){var t=this.getScriptContent(e,w);if(t){var r=this.babelJs(t,w,!0);r&&r.code&&this.getNpmComponent(this.getConfig(r.code)).then(function(s){F.getModuleName(r.code,"component").then(function(e){e=e.replace(/require\(['"]([\w\d_\-\.\/]+)['"]\)/gi,function(e,t){var r="require('"+t+"')";if(0!==t.indexOf(".")&&0!==t.indexOf("/")){var i=t.split("/"),a=i.length,n=i[0],s=_path2.default.resolve(projectPath,"./node_modules/"+n),l=_path2.default.resolve(s,"package.json");if(1<a){var o=_path2.default.parse(w),u=t.replace(".js","")+".js",c=_path2.default.resolve(o.dir,u);if(_fs2.default.existsSync(c))F.depCopyNpm(c),r="require('./"+u+"')";else{var f=_path2.default.resolve(distPath,"./npm/"+u),d=_path2.default.relative(j,f).replace(".."+_path2.default.sep,"").replace(/\\|\//gi,"/");F.depCopyNpm(f.replace("dist"+_path2.default.sep+"npm","node_modules")),r="require('"+d+"')"}}else if(0<t.indexOf(".js"))r="require('./"+t+"')";else{var p=_path2.default.parse(w),h=_path2.default.resolve(p.dir,"./"+t+".js");if(_fs2.default.existsSync(h))F.depCopyNpm(h);else if(_fs2.default.existsSync(l)){var g=_fs2.default.readFileSync(l,{encoding:"utf8"}),_=new Function("return "+g)().main,v=_path2.default.resolve(s,_),m=_path2.default.resolve(distPath,"./npm/"+n+"/"+_),y=_path2.default.relative(j,m).replace(".."+_path2.default.sep,"").replace(/\\|\//gi,"/");F.depCopyNpm(v),r="require('"+y+"')"}else util.log("[错误]".red+" 未发现模块 ".red+n.red)}}else{var x=t.replace(".js","")+".js",S=_path2.default.parse(P),b=_path2.default.resolve(S.dir,x);F.depCopyNpm(b)}return r});var t=process.env.NODE_ENV,r=l.replace(".xu",".js"),i=l.replace(".xu",".json");if("production"===t){var a=F.upjs(e).code,n=F.trim(s);F.writeFile(r,a),F.log("[写入]".green+" JS  : dist"+r),F.writeFile(i,n),F.log("[写入]".green+" JSON: dist"+i)}else F.writeFile(r,e),F.log("[写入]".green+" JS  : dist"+r),F.writeFile(i,s),F.log("[写入]".green+" JSON: dist"+i)})})}var i=l.replace(".xu",".wxml"),a=this.getWxml(e);this.writeFile(i,a||""),this.log("[写入]".green+" WXML: dist"+i);var n=this.getStyle(e,w),s=l.replace(".xu",".wxss");this.writeFile(s,n||""),this.log("[写入]".green+" WXSS: dist"+s)}},depCopyNpm:function(P){var j=this;if(comArr.indexOf(P)<0){comArr.push(P);var e=P.replace(projectPath,"");if(_fs2.default.existsSync(P)){var t=_fs2.default.readFileSync(P,{encoding:"utf8"}),r="/npm"+P.split("node_modules")[1],N=P.replace("node_modules","dist/npm"),i=this.babelJs(t,P,!0);if(i&&i.code){var a=i.code.replace(/process\.env\.NODE_ENV/g,JSON.stringify(process.env.NODE_ENV)).replace(/require\(['"]([\w\d_\-\.\/]+)['"]\)/gi,function(e,t){var r="require('"+t+"')";if(0!==t.indexOf(".")&&0!==t.indexOf("/")){var i=t.split("/"),a=i.length,n=i[0],s=_path2.default.resolve(projectPath,"./node_modules/"+n),l=_path2.default.resolve(s,"package.json");if(1<a){var o=_path2.default.parse(P),u=t.replace(".js","")+".js",c=_path2.default.resolve(s,u),f=_path2.default.resolve(o.dir,u);if(_fs2.default.existsSync(f))j.depCopyNpm(f),r="require('./"+u+"')";else{var d=_path2.default.resolve(distPath,"./npm/"+u),p=_path2.default.relative(N,d).replace(".."+_path2.default.sep,"").replace(/\\|\//gi,"/");j.depCopyNpm(c),r="require('"+p+"')"}}else{var h=_path2.default.parse(P);if(0<t.indexOf(".js")){var g=P.replace(h.base,t);j.depCopyNpm(g),r="require('./"+t+"')"}else{var _=_path2.default.resolve(h.dir,"./"+t+".js");if(_fs2.default.existsSync(_))j.depCopyNpm(_);else if(_fs2.default.existsSync(l)){var v=_fs2.default.readFileSync(l,{encoding:"utf8"}),m=new Function("return "+v)().main||"index.js",y=_path2.default.resolve(s,m),x=_path2.default.resolve(distPath,"./npm/"+n+"/"+m),S=_path2.default.relative(N,x).replace(".."+_path2.default.sep,"").replace(/\\|\//gi,"/");j.depCopyNpm(y),r="require('"+S+"')"}else util.log("[错误]".red+" 未发现模块 ".red+n.red)}}}else{var b=t.replace(".js","")+".js",w=_path2.default.parse(P),F=_path2.default.resolve(w.dir,b);j.depCopyNpm(F)}return r});if("production"===process.env.NODE_ENV){var n=this.upjs(a).code;this.writeFile(r,n),this.log("[写入]".green+" JS  : dist"+r)}else this.writeFile(r,a),this.log("[写入]".green+" JS  : dist"+r)}}else this.log("[错误]".red+" 未发现文件 ".red+e.red)}},getModuleName:function(a,n){var s=this;if("undefined"!==a)return new Promise(function(e,t){var r=a.match(/require(.*)wexp(.*)['"]\)/gi);if(!r||r.length<=0)s.log("未发现wexp依赖".red);else{var i=r[0];e(a=a.replace(/exports\.default\s*=\s*(\w+);/gi,function(e,t){if("undefined"===t)return"";var r="";return"page"===n?r="\nPage("+i+".default.$createPage("+t+"));\n":"app"===n?r="\nApp("+i+".default.$createApp("+t+"));\n":"component"===n&&(r="\nComponent("+i+".default.$createComponent("+t+"));\n"),r}))}})},writeFile:function(e,t){var r=_path2.default.resolve(process.cwd(),"dist"+e),i=r.split(_path2.default.sep),a=_path2.default.sep+i[i.length-1],n=r.replace(a,"");_fs2.default.existsSync(n)?_fs2.default.writeFileSync(r,t):this.mkdirsSync(n).then(function(e){_fs2.default.writeFileSync(r,t)})},mkdirsSync:function(r){var i=this;return new Promise(function(e,t){_fs2.default.existsSync(r)?e(!0):i.mkdirsSync(_path2.default.dirname(r))&&(_fs2.default.mkdirSync(r),e(!0))})},createDir:function(r){return new Promise(function(e,t){r=_path2.default.resolve(process.cwd(),"dist"+r),_fs2.default.existsSync(distPath)||_fs2.default.mkdirSync(r),e()})},upjs:function(e){return _uglifyJs2.default.minify(e)},trim:function(e){return e.replace(/\s+/g,"").replace(/[\r\n]/g,"")},log:function(e){var t=this.getTime();console.log(t.grey+" "+e)},getTime:function(){var e=new Date;return"["+this.getFriendlyTime(e.getHours())+":"+this.getFriendlyTime(e.getMinutes())+":"+this.getFriendlyTime(e.getSeconds())+"]"},getFriendlyTime:function(e){return e<10?"0"+e:e},delDir:function(e,t){var r=this,i=e.replace("src","dist");t?this.deleteFolderRecursive(i):0<e.indexOf(".xu")?["json","js","wxml","wxss"].forEach(function(e){r.delFile(i.replace(".xu","."+e))}):this.delFile(i)},delFile:function(e){if(_fs2.default.existsSync(e)){_fs2.default.unlinkSync(e);var t=this.getExt(e),r=e.replace(distPath,"dist");this.log("[删除]".red+" "+t+": "+r)}},deleteFolderRecursive:function(r){var i=this;_fs2.default.existsSync(r)&&(_fs2.default.readdirSync(r).forEach(function(e){var t=r+"/"+e;_fs2.default.statSync(t).isDirectory()?i.deleteFolderRecursive(t):i.delFile(t)}),_fs2.default.rmdirSync(r))},doCopy:function(){var r=this,i=_path2.default.join(__dirname,"../../wexp/dist"),a=_path2.default.join(projectPath,"./dist/wexp");_fs2.default.exists(a,function(e){if(!e){var t="cp -r "+i+" "+a;_sh2.default.exec(t,function(){r.log("拷贝依赖文件".green)})}})},isEmptyObj:function(e){return 0===Object.keys(e).length},getWexpConfig:function(){return configStatus||(wexpConfig=require(configPath),configStatus=!0),wexpConfig},parseSpecialCode:function(e){return e.replace(/\&lt\;/gi,"<").replace(/\&amp\;/gi,"&")},getAbsolutePath:function(e){return _path2.default.resolve(projectPath,e)},getExt:function(e){var t=_path2.default.parse(e).ext.replace(".","").toUpperCase(),r=Buffer.byteLength(t,"utf8");return t+new Array(4<r?0:4-r).fill(" ").join("")}};