"use strict";var fs=require("fs"),path=require("path"),babel=require("babel-core"),stage1=require("babel-preset-stage-1"),es2015=require("babel-preset-es2015"),DOMParser=require("xmldom").DOMParser,uglifyjs=require("uglify-js"),less=require("less"),minCss=require("cssmin"),colors=require("colors"),sh=require("shelljs"),projectPath=process.cwd(),srcPath=path.resolve(projectPath,"src"),distPath=path.resolve(projectPath,"dist");function find_r(e,r){for(var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"{",n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"}",s=[],i=r,c=e.length;i<c;i++){var a=e.charAt(i);if(t==a)s.push(i);else{if(n!=a)continue;if(s.pop(),!s.length)return i+1}}return r}function findstr(e,r){var t=e.indexOf(r),n=0;return-1===t?"":(n=find_r(e,t),e.substring(t,n))}module.exports={getScriptContent:function(e,n){var s="",r=(new DOMParser).parseFromString(e);return[].slice.call(r.childNodes||[]).forEach(function(e){var r=e.nodeName;if("script"===r&&e.hasAttribute("src")){var t=path.resolve(path.dirname(n),e.getAttribute("src"));s=fs.readFileSync(t,{encoding:"utf8"})}else"script"===r&&[].slice.call(e.childNodes||[]).forEach(function(e){s+=e.toString()})}),s},getWxml:function(e){var r="",t=(new DOMParser).parseFromString(e);return[].slice.call(t.childNodes||[]).forEach(function(e){"template"===e.nodeName&&[].slice.call(e.childNodes||[]).forEach(function(e){r+=e.toString()})}),r},getStyle:function(e,r){var c=this,a="",t=process.env.NODE_ENV,o="src"+this.getRelativePath(r),n=(new DOMParser).parseFromString(e);return[].slice.call(n.childNodes||[]).forEach(function(e){if("style"===e.nodeName){var r=e.hasAttribute("src"),t=e.hasAttribute("lang");if(r)if(t){var n=e.getAttribute("lang"),s='@import "'+e.getAttribute("src").replace("."+n,".wxss")+'";';a+=s}else c.log(" [style引用错误]".red+" 请搭配lang属性使用");else if(!r&&t){switch([].slice.call(e.childNodes||[]).forEach(function(e){a+=e.toString()}),e.getAttribute("lang")){case"less":var i=a.match(/\@import(.*)["']\;/gi);a=a.replace(/\@import(.*)['"]\;/gi,"");try{less.render(a,function(e,r){if(e)throw e;a=r.css.toString(),i.forEach(function(e){a=e.replace(".less",".wxss")+"\n"+a})})}catch(e){c.log(" "+c.catch(e.name).red+o),console.log(e)}}}else r||t||[].slice.call(e.childNodes||[]).forEach(function(e){a+=e.toString()})}}),"production"===t&&(a=minCss(a)),a},getJsContent:function(e){var r="",t=process.env.NODE_ENV,n=fs.readFileSync(e,{encoding:"utf8"}),s=this.babelJs(n,e);return r=s.code,"production"===t&&(r=this.upjs(s.code).code),r},compileStyle:function(e,r){var t="",n=process.env.NODE_ENV,s=fs.readFileSync(e,{encoding:"utf8"}),i="src"+this.getRelativePath(e);switch(r){case"less":var c=s.match(/\@import(.*)["']\;/gi);s=s.replace(/\@import(.*)['"]\;/gi,"");try{less.render(s,function(e,r){if(e)throw e;t=r.css.toString(),c&&c.forEach(function(e){t=e.replace(".less",".wxss")+"\n"+t})})}catch(e){this.log(" "+this.catch(e.name).red+i),console.log(e)}break;case"wxss":t=s}return"production"===n&&0<t.length&&(t=minCss(t)),t},babelJs:function(e,r){var t=r.substring(r.lastIndexOf("/")+1,r.lastIndexOf(".")),n=this.getRelativePath(r);if(e)try{return babel.transform(e,{filename:t,presets:[es2015,stage1]})}catch(e){this.log(" "+this.catch(e.name).red+" src"+n),console.log(e.stack)}},catch:function(e){var r="[语法错误]";switch(e){case"SyntaxError":r="[语法错误]";break;case"ReferenceError":r="[变量未定义错误]";break;case"RangeError":r="[超出有效值错误]";break;case"TypeError":r="[类型不匹配错误]";break;case"URIError":r="[函数参数不正确错误]";break;case"EvalError":r="[eval函数未执行错误]"}return r},getTypeUrl:function(e){var r=e.replace(path.resolve(process.cwd(),"src"),""),t={type:"app",path:"/"};return 0===r.indexOf("/pages")?t.type="page":0===r.indexOf("/components")?t.type="component":0===r.indexOf("/app.xu")&&(t.type="app"),t},getRelativePath:function(e){return e.replace(srcPath,"")},getConfig:function(e){process.env.NODE_ENV;var r=".config = ";return findstr(e,r).replace(r,"").replace(/(?:\s*['"]*)?([a-zA-Z0-9\-]+)(?:['"]*\s*)?:/g,"'$1':").replace(/'/gi,'"')},getModuleName:function(t,s){if("undefined"!==t)return new Promise(function(e,r){var n=t.match(/require(.*)wexp\/index['"]\)/gi)[0];e(t=t.replace(/exports\.default\s*=\s*(\w+);/gi,function(e,r){if("undefined"===r)return"";var t="";return"page"===s?t="\nPage("+n+".default.$createPage("+r+"));\n":"app"===s?t="\nApp("+n+".default.$createApp("+r+"));\n":"component"===s&&(t="\nComponent("+n+".default.$createComponent("+r+"));\n"),t}))})},writeFile:function(e,r){var t=path.resolve(process.cwd(),"dist"+e),n=t.split("/"),s="/"+n[n.length-1],i=t.replace(s,"");fs.existsSync(i)?fs.writeFileSync(t,r):this.mkdirsSync(i).then(function(e){fs.writeFileSync(t,r)})},mkdirsSync:function(t){var n=this;return new Promise(function(e,r){fs.existsSync(t)?e(!0):n.mkdirsSync(path.dirname(t))&&(fs.mkdirSync(t),e(!0))})},createDir:function(t){return new Promise(function(e,r){t=path.resolve(process.cwd(),"dist"+t),fs.existsSync(distPath)||fs.mkdirSync(t),e()})},upjs:function(e){return uglifyjs.minify(e)},trim:function(e){return e.replace(/\s+/g,"").replace(/[\r\n]/g,"")},log:function(e){var r=this.getTime();console.log(r.grey+e)},getTime:function(){var e=new Date;return"["+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+"]"},delDir:function(e,r){var t=this,n=this.getRelativePath(e),s=path.resolve(process.cwd(),"dist"+n);if(r){var i="rm -rf "+s;sh.exec(i,function(){t.log(" [删除文件夹]".red+" dist"+n)})}else{var c=s.split("/"),a=c[c.length-1],o="rm "+s.replace(a,"")+(a.split(".")[0]+".*");sh.exec(o,function(){n.indexOf(".xu")?["json","js","wxml","wxss"].forEach(function(e){t.log(" [删除文件]".red+" dist"+n.replace(".xu","."+e))}):t.log(" [删除文件]".red+" dist"+n)})}},doCopy:function(){var t=this,n=path.join(__dirname,"../../wexp/dist"),s=path.join(projectPath,"./dist/wexp");fs.exists(s,function(e){if(!e){var r="cp -r "+n+" "+s;sh.exec(r,function(){t.log("拷贝依赖文件".green)})}})}};