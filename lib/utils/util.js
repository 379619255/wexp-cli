"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path=require("path"),_path2=_interopRequireDefault(_path),_babel=require("./babel"),_babel2=_interopRequireDefault(_babel),_babelPresetStage=require("babel-preset-stage-1"),_babelPresetStage2=_interopRequireDefault(_babelPresetStage),_babelPresetEs=require("babel-preset-es2015"),_babelPresetEs2=_interopRequireDefault(_babelPresetEs),_xmldom=require("xmldom"),_uglifyJs=require("uglify-js"),_uglifyJs2=_interopRequireDefault(_uglifyJs),_less=require("less"),_less2=_interopRequireDefault(_less),_cssmin=require("cssmin"),_cssmin2=_interopRequireDefault(_cssmin),_colors=require("colors"),_colors2=_interopRequireDefault(_colors),_sh=require("./sh"),_sh2=_interopRequireDefault(_sh),_readline=require("readline"),_readline2=_interopRequireDefault(_readline);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var projectPath=process.cwd(),srcPath=_path2.default.resolve(projectPath,"src"),distPath=_path2.default.resolve(projectPath,"dist"),wexpConfig={},eslintignore=[];function find_r(e,t){for(var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"{",i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"}",n=[],a=t,s=e.length;a<s;a++){var l=e.charAt(a);if(r==l)n.push(a);else{if(i!=l)continue;if(n.pop(),!n.length)return a+1}}return t}function findstr(e,t){var r=e.indexOf(t),i=0;return-1===r?"":(i=find_r(e,r),e.substring(r,i))}exports.default={getDomParser:function(e){return new _xmldom.DOMParser({locator:{},errorHandler:{warning:function(e){},error:function(e){}}}).parseFromString(e)},getScriptContent:function(e,i){var n="",a=this,t=this.getDomParser(e);return[].slice.call(t.childNodes||[]).forEach(function(e){var t=e.nodeName;if("script"===t&&e.hasAttribute("src")){var r=_path2.default.resolve(_path2.default.dirname(i),e.getAttribute("src"));n=_fs2.default.readFileSync(r,{encoding:"utf8"})}else"script"===t&&[].slice.call(e.childNodes||[]).forEach(function(e){n+=a.parseSpecialCode(e.toString())})}),n},getWxml:function(e){var t="",r=this,i=this.getDomParser(e);return[].slice.call(i.childNodes||[]).forEach(function(e){"template"===e.nodeName&&[].slice.call(e.childNodes||[]).forEach(function(e){t+=r.parseSpecialCode(e.toString())})}),t},getStyle:function(e,b){var x=this,y="",t=process.env.NODE_ENV,r=(this.getRelativePath(b),this.getDomParser(e));return[].slice.call(r.childNodes||[]).forEach(function(e){if("style"===e.nodeName){var t=e.hasAttribute("src"),r=e.hasAttribute("lang"),i=e.getAttribute("src");if(t)if(r){var n=i.split("/"),a=x.getFilename(i),s=x.getFilename(b),l=e.getAttribute("lang");if((2===n.length&&"."===n[0]||1===n.length)&&a===s){var o=b.replace(".xu","."+l);if(x.hasXuFile(o,!0)){var c=x.readFile(b.replace(".xu","."+l));y+=x.renderStyle(l,c)}else y+=""}else{var u='@import "'+e.getAttribute("src").replace("."+l,".wxss")+'";';y+=u}}else if(0<i.indexOf(".wxss")){var f=i.split("/"),d=x.getFilename(i),p=x.getFilename(b),h="wxss";if((2===f.length&&"."===f[0]||1===f.length)&&d===p){var g=b.replace(".xu","."+h);if(x.hasXuFile(g,!0)){var _=x.readFile(b.replace(".xu","."+h));y+=x.renderStyle(h,_)}else y+=""}else{var m='@import "'+e.getAttribute("src")+'";';y+=m}}else x.log(" [style引用错误]".red+" 请搭配lang属性使用");else if(!t&&r){[].slice.call(e.childNodes||[]).forEach(function(e){y+=e.toString()});var v=e.getAttribute("lang");y=x.renderStyle(v,y)}else t||r||[].slice.call(e.childNodes||[]).forEach(function(e){y+=e.toString()})}}),"production"===t&&(y=(0,_cssmin2.default)(y)),y},renderStyle:function(e,r){switch(e){case"less":var i=r.match(/\@import(.*)["']\;/gi);r=r.replace(/\@import(.*)['"]\;/gi,"");try{_less2.default.render(r,function(e,t){if(e)throw e;r=t.css.toString(),i&&i.forEach(function(e){r=e.replace(".less",".wxss")+"\n"+r})})}catch(e){this.log(" "+this.catch(e.name).red),console.log(e)}}return r},readFile:function(e){try{return _fs2.default.readFileSync(e,{encoding:"utf8"})}catch(e){this.log(" "+this.catch(e.name).red),console.log(e)}},readFileOnLine:function(i){var n=this;return new Promise(function(t,e){if(n.hasXuFile(i,!0)&&0===eslintignore.length){var r=_readline2.default.createInterface({input:_fs2.default.createReadStream(i)});r.on("line",function(e){eslintignore.push(e)}),r.on("close",function(e){t(eslintignore)})}else t(eslintignore)})},getJsContent:function(e){var t="",r=process.env.NODE_ENV,i=_fs2.default.readFileSync(e,{encoding:"utf8"}),n=this.babelJs(i,e);return n&&n.code&&(t=n.code,"production"===r&&(t=this.upjs(n.code).code)),t},compileStyle:function(e,t){var r="",i=process.env.NODE_ENV,n=this.readFile(e);this.getRelativePath(e);return r+=this.renderStyle(t,n),"production"===i&&0<r.length&&(r=(0,_cssmin2.default)(r)),r},hasXuFile:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],r=_fs2.default.existsSync(e);if(!r&&t){var i=this.getRelativePath(e);this.log(" [找不到文件]".red+" src"+i)}return r},getFilename:function(e){return e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."))},babelJs:function(e,t){var r=this.getFilename(t),i=this.getRelativePath(t);if(e)try{return _babel2.default.transform(e,{filename:r,presets:[_babelPresetEs2.default,_babelPresetStage2.default]})}catch(e){this.log(" "+this.catch(e.name).red+" src"+i),console.log(e.stack)}},catch:function(e){var t="[语法错误]";switch(e){case"SyntaxError":t="[语法错误]";break;case"ReferenceError":t="[变量未定义错误]";break;case"RangeError":t="[超出有效值错误]";break;case"TypeError":t="[类型不匹配错误]";break;case"URIError":t="[函数参数不正确错误]";break;case"EvalError":t="[eval函数未执行错误]"}return t},getTypeUrl:function(e){var t=e.replace(_path2.default.resolve(process.cwd(),"src"),""),r={type:"app",path:"/"};return 0===t.indexOf("/pages")?r.type="page":0===t.indexOf("/components")?r.type="component":0===t.indexOf("/app.xu")&&(r.type="app"),r},getRelativePath:function(e){return e.replace(srcPath,"")},getConfig:function(e){process.env.NODE_ENV;var t=".config = ";return findstr(e,t).replace(t,"").replace(/(?:\s*['"]*)?([a-zA-Z0-9\-]+)(?:['"]*\s*)?:/g,'"$1":').replace(/'/gi,'"')},getModuleName:function(r,n){if("undefined"!==r)return new Promise(function(e,t){var i=r.match(/require(.*)wexp\/index['"]\)/gi)[0];e(r=r.replace(/exports\.default\s*=\s*(\w+);/gi,function(e,t){if("undefined"===t)return"";var r="";return"page"===n?r="\nPage("+i+".default.$createPage("+t+"));\n":"app"===n?r="\nApp("+i+".default.$createApp("+t+"));\n":"component"===n&&(r="\nComponent("+i+".default.$createComponent("+t+"));\n"),r}))})},writeFile:function(e,t){var r=_path2.default.resolve(process.cwd(),"dist"+e),i=r.split("/"),n="/"+i[i.length-1],a=r.replace(n,"");_fs2.default.existsSync(a)?_fs2.default.writeFileSync(r,t):this.mkdirsSync(a).then(function(e){_fs2.default.writeFileSync(r,t)})},mkdirsSync:function(r){var i=this;return new Promise(function(e,t){_fs2.default.existsSync(r)?e(!0):i.mkdirsSync(_path2.default.dirname(r))&&(_fs2.default.mkdirSync(r),e(!0))})},createDir:function(r){return new Promise(function(e,t){r=_path2.default.resolve(process.cwd(),"dist"+r),_fs2.default.existsSync(distPath)||_fs2.default.mkdirSync(r),e()})},upjs:function(e){return _uglifyJs2.default.minify(e)},trim:function(e){return e.replace(/\s+/g,"").replace(/[\r\n]/g,"")},log:function(e){var t=this.getTime();console.log(t.grey+e)},getTime:function(){var e=new Date;return"["+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+"]"},delDir:function(e,t){var r=this,i=this.getRelativePath(e),n=_path2.default.resolve(process.cwd(),"dist"+i);if(t){var a="rm -rf "+n;_sh2.default.exec(a,function(){r.log(" [删除文件夹]".red+" dist"+i)})}else{var s=n.split("/"),l=s[s.length-1],o="rm "+n.replace(l,"")+(l.split(".")[0]+".*");_sh2.default.exec(o,function(){0<=i.indexOf(".xu")?["json","js","wxml","wxss"].forEach(function(e){r.log(" [删除文件]".red+" dist"+i.replace(".xu","."+e))}):r.log(" [删除文件]".red+" dist"+i)})}},doCopy:function(){var r=this,i=_path2.default.join(__dirname,"../../wexp/dist"),n=_path2.default.join(projectPath,"./dist/wexp");_fs2.default.exists(n,function(e){if(!e){var t="cp -r "+i+" "+n;_sh2.default.exec(t,function(){r.log("拷贝依赖文件".green)})}})},isEmptyObj:function(e){return 0===Object.keys(e).length},getWexpConfig:function(){var e=Object.assign({},wexpConfig);if(this.isEmptyObj(e)){var t=_path2.default.resolve(process.cwd(),"wexp.config.js");e=require(t)}return e},parseSpecialCode:function(e){return e.replace(/\&lt\;/gi,"<").replace(/\&amp\;/gi,"&")},getAbsolutePath:function(e){return _path2.default.resolve(projectPath,e)}};