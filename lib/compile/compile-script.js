"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=function(r,e){var t=_util2.default.getRelativePath(r),d=t.replace(".xu",".js");if(0<r.indexOf(".xu")){var l=_util2.default.babelJs(e,r);l&&l.code&&_util2.default.getNpmComponent(_util2.default.getConfig(l.code)).then(function(a){var i=t.replace(".xu",".json"),e=_util2.default.getTypeUrl(r);_util2.default.getModuleName(l.code,e.type).then(function(e){if(e=doAnalyseRequire(e,r),"production"===process.env.NODE_ENV){var t=_util2.default.upjs(e).code,l=_util2.default.trim(a);_util2.default.writeFile(d,t),_util2.default.log("[写入]".green+" JS  : dist"+d),_util2.default.writeFile(i,l),_util2.default.log("[写入]".green+" JSON: dist"+i)}else{_util2.default.writeFile(d,e),_util2.default.log("[写入]".green+" JS  : dist"+d);var u=new Function("return "+a)();a=JSON.stringify(u,null,4),_util2.default.writeFile(i,a),_util2.default.log("[写入]".green+" JSON: dist"+i)}})})}else{var u=_util2.default.getJsContent(r);u=doAnalyseRequire(u,r),_util2.default.writeFile(t,u),_util2.default.log("[拷贝]".yellow+" JS  : dist"+d)}};var _fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path=require("path"),_path2=_interopRequireDefault(_path),_util=require("../utils/util"),_util2=_interopRequireDefault(_util);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var projectPath=process.cwd(),distPath=_path2.default.resolve(projectPath,"dist"),nodePath=_path2.default.resolve(projectPath,"./node_modules");function doAnalyseRequire(e,C){return e.replace(/require\(['"]([\w\d_\-\.\/]+)['"]\)/gi,function(e,t){var l="require('"+t+"')";if(0!==t.indexOf(".")&&0!==t.indexOf("/")){var u=t.split("/"),a=u.length,i=u[0],r=_path2.default.resolve(projectPath,"./node_modules/"+i),d=_path2.default.resolve(r,"package.json");if(1<a){var f=t.replace(".js","")+".js",s=_path2.default.resolve(nodePath,f),p=_path2.default.parse(C),n=_path2.default.resolve(p.dir,f);if(_fs2.default.existsSync(n))_util2.default.depCopyNpm(n),l="require('./"+f+"')";else{var o=_path2.default.resolve(distPath,"./npm/"+f),_=C.replace("src","dist"),c=_path2.default.relative(_,o).replace(".."+_path2.default.sep,"").replace(/\\|\//gi,"/");if(_fs2.default.existsSync(d)){var h=_fs2.default.readFileSync(d,{encoding:"utf8"}),v=new Function("return "+h)();if(v.miniprogram){var g=_path2.default.resolve(r,"./"+v.miniprogram),y=_path2.default.resolve(g,f.replace(i,"."));_fs2.default.existsSync(y)?_util2.default.depCopyNpm(y):_util2.default.depCopyNpm(s)}else _util2.default.depCopyNpm(s)}else _util2.default.depCopyNpm(s);l="require('"+c+"')"}}else if(0<t.indexOf(".js"))l="require('./"+t+"')";else{var m=_path2.default.parse(C),q=_path2.default.resolve(m.dir,"./"+t+".js");if(_fs2.default.existsSync(q))_util2.default.depCopyNpm(q);else if(_fs2.default.existsSync(d)){var x=_fs2.default.readFileSync(d,{encoding:"utf8"}),N=new Function("return "+x)().main,j=_path2.default.resolve(r,N),S=_path2.default.resolve(distPath,"./npm/"+i+"/"+N),w=C.replace("src","dist"),P=_path2.default.relative(w,S).replace(".."+_path2.default.sep,"").replace(/\\|\//gi,"/");_util2.default.depCopyNpm(j),l="require('"+P+"')"}else _util2.default.log("[错误]".red+" 未发现模块 ".red+i.red)}}return l})}