"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=function(i,e){var t=_util2.default.getRelativePath(i),d=t.replace(".xu",".js");if(0<i.indexOf(".xu")){var l=_util2.default.babelJs(e,i);l&&l.code&&_util2.default.getNpmComponent(_util2.default.getConfig(l.code)).then(function(u){var r=t.replace(".xu",".json"),e=_util2.default.getTypeUrl(i);_util2.default.getModuleName(l.code,e.type).then(function(e){if(e=doAnalyseRequire(e,i),"production"===process.env.NODE_ENV){var t=_util2.default.upjs(e).code,l=_util2.default.trim(u);_util2.default.writeFile(_path2.default.resolve(projectPath,d),t),_util2.default.log("[写入]".green+" JS  : dist"+d),_util2.default.writeFile(_path2.default.resolve(projectPath,r),l),_util2.default.log("[写入]".green+" JSON: dist"+r)}else{_util2.default.writeFile(_path2.default.resolve(projectPath,d),e),_util2.default.log("[写入]".green+" JS  : dist"+d);var a=new Function("return "+u)();u=JSON.stringify(a,null,4),_util2.default.writeFile(_path2.default.resolve(projectPath,r),u),_util2.default.log("[写入]".green+" JSON: dist"+r)}})})}else{var a=_util2.default.getJsContent(i);a=doAnalyseRequire(a,i),_util2.default.writeFile(_path2.default.resolve(projectPath,t),a),_util2.default.log("[拷贝]".yellow+" JS  : dist"+d)}};var _fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path=require("path"),_path2=_interopRequireDefault(_path),_util=require("../utils/util"),_util2=_interopRequireDefault(_util);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var projectPath=process.cwd(),distPath=_path2.default.resolve(projectPath,"dist"),nodePath=_path2.default.resolve(projectPath,"./node_modules");function doAnalyseRequire(e,C){return e.replace(/require\(['"]([\w\d_\-\.\/]+)['"]\)/gi,function(e,t){var l="require('"+t+"')";if(0!==t.indexOf(".")&&0!==t.indexOf("/")){var a=t.split("/"),u=a.length,r=a[0],i=_path2.default.resolve(projectPath,"./node_modules/"+r),d=_path2.default.resolve(i,"package.json");if(1<u){var f=t.replace(".js","")+".js",s=_path2.default.resolve(nodePath,f),p=_path2.default.parse(C),o=_path2.default.resolve(p.dir,f);if(_fs2.default.existsSync(o))_util2.default.depCopyNpm(o),l="require('./"+f+"')";else{var n=_path2.default.resolve(distPath,"./npm/"+f),_=C.replace("src","dist"),c=_path2.default.relative(_,n).replace("../","");if(_fs2.default.existsSync(d)){var h=_fs2.default.readFileSync(d,{encoding:"utf8"}),v=new Function("return "+h)();if(v.miniprogram){var g=_path2.default.resolve(i,"./"+v.miniprogram),y=_path2.default.resolve(g,f.replace(r,"."));_fs2.default.existsSync(y)?_util2.default.depCopyNpm(y):_util2.default.depCopyNpm(s)}else _util2.default.depCopyNpm(s)}else _util2.default.depCopyNpm(s);l="require('"+c+"')"}}else if(0<t.indexOf(".js"))l="require('./"+t+"')";else{var m=_path2.default.parse(C),j=_path2.default.resolve(m.dir,"./"+t+".js");if(_fs2.default.existsSync(j))_util2.default.depCopyNpm(j);else if(_fs2.default.existsSync(d)){var q=_fs2.default.readFileSync(d,{encoding:"utf8"}),P=new Function("return "+q)().main,x=_path2.default.resolve(i,P),N=_path2.default.resolve(distPath,"./npm/"+r+"/"+P),S=C.replace("src","dist"),w=_path2.default.relative(S,N).replace("../","");_util2.default.depCopyNpm(x),l="require('"+w+"')"}else _util2.default.log("[错误]".red+" 未发现模块 ".red+r.red)}}return l})}